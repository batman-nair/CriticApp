{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.6/dist/css/autoComplete.02.min.css">
<link rel="stylesheet" href="{% static 'review/css/review.css' %}">

<h1>Add Review</h1>

<div class="input-group mb-4">
  <select id="review-category" class="flex-shrink-1 form-select" aria-label="Select Category">
    <option value="movie">Movie</option>
    <option value="game">Game</option>
  </select>
  <input id="autoComplete" class="form-control">
</div>

<div id="review-card" class="card mb-3" hidden>
  <div class="row g-0">
    <div class="col-md-4">
      <img class="img-fluid rounded-start" alt="Poster Image">
    </div>
    <div class="col-md-8">
      <div class="card-body">
        <h5 class="review-title card-title">Review Title <small class="year text-muted text-end">Year</small></h5>
        <p class="card-text"><small class="attr1 text-muted">Attribute 1</small></p>
        <p class="description card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
        <p class="attr2 card-text">Attribute 2</p>
        <p class="rating card-text">Rating</p>
      </div>
    </div>
  </div>
</div>

<form method="post">
  {% csrf_token %}
  {{ form|crispy }}
  <input type="submit" value="Submit">
</form>


<script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.6/dist/autoComplete.min.js"></script>
<script src="{% static 'review/js/review.js' %}"></script>

<script>
    config = {
      data: {
        src: async (query) => {
          const category = document.querySelector("#review-category").value
          try {
            return getSearchItems(category, query)
          } catch (error) {
            console.log("Error fetching search data ", query, error)
            return error
          }
        },
        keys: ["Title"],
      },
      searchEngine: (query, record) => {
        return record;
      },
      placeHolder: 'Search...',
      threshold: 3,
      debounce: 300,
      resultItem: {
        element: (item, data) => {
          const item_img = document.createElement('img')
          const image_url = data['value']['ImageURL']
          if (image_url == "N/A") {
              return
          }
          item_img.src = image_url
          item.prepend(item_img)
          item.classList.add('review-search-element')
          const year_span = document.createElement('small')
          year_span.innerText = data['value']['Year']
          item.append(year_span)
        }
      },
      submit: false,
    }
    const autoCompleteJS = new autoComplete(config);

    const reviewCard = document.querySelector("#review-card")
    document.querySelector("#autoComplete").addEventListener("selection", function (event) {
      const category = document.querySelector("#review-category").value
      const selection = event.detail.selection.value
      const itemID = selection["ItemID"]
      updateReviewItem(category, itemID, reviewCard)
      updateForm(category, itemID)
      console.log('Selected: ', selection, event.detail);
    });
</script>
{% endblock content %}